<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Ver Notificación</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
<div class="container mx-auto bg-white shadow-xl rounded-xl p-6 max-w-2xl">

    <!-- Encabezado -->
    <h2 class="text-2xl font-bold mb-6 text-green-700">
        Enviado por {{ notificacion.rol_remitente }} {{ remitente_nombre }}
    </h2>

    <!-- Motivo -->
    <div class="mb-4">
        <label class="block text-sm font-semibold text-gray-700 mb-1">Motivo del mensaje</label>
        <div class="p-3 border rounded-md bg-gray-50 text-gray-800">
            {{ notificacion.mensaje.split(']')[0].replace('[','') }}
        </div>
    </div>

    <!-- Mensaje -->
    <div class="mb-4">
        <label class="block text-sm font-semibold text-gray-700 mb-1">Mensaje</label>
        <div class="p-3 border rounded-md bg-gray-50 text-gray-800">
            {{ notificacion.mensaje.split(']')[1] if ']' in notificacion.mensaje else notificacion.mensaje }}
        </div>
    </div>

    <!-- Fecha -->
    <p class="text-sm text-gray-500 mb-6">
        {{ fecha_local.strftime('%d/%m/%Y %H:%M') }}
    </p>

    <!-- Formulario para responder -->
    <form id="respuestaForm" method="POST"
      action="{% if current_user.__class__.__name__ == 'Administrador' %}
                  {{ url_for('adm_bp.responder_notificacion', noti_id=notificacion.id) }}
              {% elif current_user.__class__.__name__ == 'Coordinador' %}
                  {{ url_for('coordinador_bp.responder_notificacion', noti_id=notificacion.id) }}
              {% elif current_user.__class__.__name__ == 'Instructor' %}
                  {{ url_for('instructor_bp.responder_notificacion', noti_id=notificacion.id) }}
              {% elif current_user.__class__.__name__ == 'Aprendiz' %}
                  {{ url_for('aprendiz_bp.responder_notificacion', noti_id=notificacion.id) }}
              {% endif %}">

        <div class="mb-4">
            <label for="respuesta" class="block text-sm font-semibold text-gray-700 mb-1">Responder mensaje</label>
            <textarea name="respuesta" id="respuesta" rows="3"
                      class="mt-1 block w-full border rounded-md p-3 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
        </div>

        <div class="flex justify-between">
            <!-- Botón Volver -->
            {% if current_user.__class__.__name__ == 'Administrador' %}
                <a href="{{ url_for('adm_bp.notificaciones') }}"
                   class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                    Volver a notificaciones
                </a>
            {% elif current_user.__class__.__name__ == 'Coordinador' %}
                <a href="{{ url_for('coordinador_bp.notificaciones') }}"
                   class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                    Volver a notificaciones
                </a>
            {% elif current_user.__class__.__name__ == 'Instructor' %}
                <a href="{{ url_for('instructor_bp.notificaciones') }}"
                   class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                    Volver a notificaciones
                </a>
            {% elif current_user.__class__.__name__ == 'Aprendiz' %}
                <a href="{{ url_for('aprendiz_bp.notificaciones') }}"
                   class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                    Volver a notificaciones
                </a>
            {% endif %}

            <button type="submit"
                    class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                Enviar respuesta
            </button>
        </div>
    </form>
</div>

<!-- Modal de éxito -->
<div id="modalSuccess" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-xl shadow-lg max-w-sm w-full text-center">
        <h3 class="text-lg font-bold mb-4 text-green-600">¡Éxito!</h3>
        <p class="mb-4">Respuesta enviada correctamente</p>
        <button id="closeModal" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
            OK
        </button>
    </div>
</div>

<!-- Script para mostrar modal y enviar respuesta -->
<script>
window.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('respuestaForm');
    const modal = document.getElementById('modalSuccess');
    const closeBtn = document.getElementById('closeModal');

    // Definir URL de redirección según el rol
    let redirectUrl = "";
    {% if current_user.__class__.__name__ == 'Administrador' %}
        redirectUrl = "{{ url_for('adm_bp.notificaciones') }}";
    {% elif current_user.__class__.__name__ == 'Coordinador' %}
        redirectUrl = "{{ url_for('coordinador_bp.notificaciones') }}";
    {% elif current_user.__class__.__name__ == 'Instructor' %}
        redirectUrl = "{{ url_for('instructor_bp.notificaciones') }}";
    {% elif current_user.__class__.__name__ == 'Aprendiz' %}
        redirectUrl = "{{ url_for('aprendiz_bp.notificaciones') }}";
    {% endif %}

    form.addEventListener('submit', function(e) {
        e.preventDefault();

        // Mostrar modal
        modal.classList.remove('hidden');

        // Enviar el formulario al cerrar el modal
        closeBtn.addEventListener('click', function() {
            modal.classList.add('hidden');

            fetch(form.action, {
                method: "POST",
                body: new FormData(form)
            })
            .then(() => {
                window.location.href = redirectUrl;
            })
            .catch(err => console.error(err));
        }, { once: true });
    });
});
</script>
</body>
</html>
