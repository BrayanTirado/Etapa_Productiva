{% extends "base.html" %}

{% block title %}SENA - Dashboard Instructor{% endblock %}

{% block content %}
<style>
/* Modal general */
.modal {
    display: none;
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    background-color: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index:1000;
}
.modal-content {
    background-color: white;
    padding: 25px;
    border-radius: 10px;
    max-width: 600px;
    width: 90%;
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    text-align: center;
}
.modal-content h3 {
    margin-top:0;
    font-size: 1.8rem;
    color:#1f2937;
    margin-bottom: 15px;
}
.modal-content p {
    margin: 8px 0;
    color: #374151;
}
.modal-content button {
    background-color: #22c55e;
    color:white;
    padding:10px 20px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    margin-top:15px;
}
.modal-content button:hover { opacity: 0.9; }

/* Dashboard cards y botones */
.card-sena {
    background-color: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.btn-sena-primary {
    background-color: #39A900;
    color:white;
    padding:12px;
    border-radius:8px;
    font-weight:600;
    text-align:center;
    transition:0.3s;
}
.btn-sena-primary:hover { background-color: #2E7D32; }
.btn-sena-secondary {
    background-color: #8BC34A;
    color:white;
    padding:12px;
    border-radius:8px;
    font-weight:600;
    text-align:center;
}
.btn-sena-secondary:hover { background-color: #689F38; }
.form-sena .form-select, .form-sena .form-textarea {
    width: 100%;
    padding:10px;
    border-radius:6px;
    border:1px solid #cbd5e1;
}
.form-sena label {
    font-weight:600;
    margin-bottom:4px;
    display:block;
}

/* Calendario más grande */
#calendario {
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
}
#calendario div {
    padding: 14px 0;
    font-weight:600;
    font-size: 1rem;
}
</style>

<!-- Header -->
<div class="bg-white shadow-md mb-6">
    <div class="container mx-auto px-4">
        <div class="flex items-center justify-between py-4">
            
            <!-- Texto centrado -->
            <div class="flex-1 text-center">
                <h2 class="text-2xl font-bold text-sena-primary">
                    Bienvenido {{ instructor.nombre_instructor }} {{ instructor.apellido_instructor }}
                </h2>
            </div>

            <!-- Notificaciones y Cerrar sesión -->
            <div class="flex items-center space-x-4">
                <!-- Campana de notificaciones -->
                <div class="relative">
                    <a href="{{ url_for('instructor_bp.notificaciones') }}" class="text-sena-primary hover:text-sena-dark">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3c0 .386-.149.735-.395 1.001L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                        {% if notificaciones_no_leidas > 0 %}
                        <span class="absolute -top-1 -right-1 inline-block w-5 h-5 bg-sena-primary text-white text-xs font-bold rounded-full text-center border-2 border-white">
                            {{ notificaciones_no_leidas }}
                        </span>
                        {% endif %}
                    </a>
                </div>

                <!-- Botón de cerrar sesión -->
                <a href="{{ url_for('auth.logout') }}" class="btn-sena-danger">Cerrar Sesión</a>
            </div>
        </div>
    </div>
</div>



<main class="container mx-auto px-4 py-6">
    <div class="flex flex-col md:flex-row gap-8">
        <!-- Calendario -->
        <div class="card-sena p-6 w-full md:w-1/3">
            <h3 class="text-xl font-bold mb-4 text-sena-dark text-center">Calendario</h3>
            <div class="flex justify-between items-center mb-4">
                <div class="flex gap-2">
                    <button id="mesAnterior" class="px-3 py-1 bg-sena-primary text-white rounded-md hover:bg-sena-dark transition">&lt;</button>
                    <select id="mes" class="border border-gray-300 rounded-md px-2 py-1 focus:ring-sena-primary focus:border-sena-primary text-sm">
                        <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option>
                        <option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option>
                        <option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option>
                        <option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                    </select>
                    <button id="mesSiguiente" class="px-3 py-1 bg-sena-primary text-white rounded-md hover:bg-sena-dark transition">&gt;</button>
                </div>
                <div class="flex items-center gap-2">
                    <button id="anioAnterior" class="px-2 py-1 bg-gray-200 rounded-md hover:bg-gray-300 transition">&lt;</button>
                    <select id="anio" class="border border-gray-300 rounded-md px-2 py-1 focus:ring-sena-primary focus:border-sena-primary text-sm"></select>
                    <button id="anioSiguiente" class="px-2 py-1 bg-gray-200 rounded-md hover:bg-gray-300 transition">&gt;</button>
                </div>
            </div>
            <div class="grid grid-cols-7 text-center text-gray-700 font-medium border-b border-gray-200 mb-2 text-sm">
                <div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div class="text-sena-secondary">Sáb</div><div class="text-sena-secondary">Dom</div>
            </div>
            <div id="calendario" class="grid gap-2"></div>

            <!-- Leyenda del calendario -->
            <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                <h4 class="text-sm font-semibold text-gray-700 mb-2">Leyenda:</h4>
                <div class="flex flex-wrap gap-4 text-xs">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-sena-primary rounded-full"></div>
                        <span>Hoy</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 bg-green-400 rounded"></div>
                        <span>Fin de etapa productiva</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones de acceso -->
        <div class="w-full md:w-2/3">
            <div class="grid grid-cols-2 gap-4 mb-6">
                <a href="/estudiantes/listarEstudiantes" class="btn-sena-primary p-6 flex flex-col items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    Estudiantes
                </a>
                <a href="{{ url_for('instructor_bp.perfil_instructor') }}" class="btn-sena-secondary p-6 flex flex-col items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    Perfil
                </a>
            </div>

            <!-- Formulario enviar mensaje -->
            <div class="card-sena p-6">
                <h3 class="text-xl font-bold mb-4 text-sena-dark text-center">Enviar Mensaje</h3>
                <form action="{{ url_for('instructor_bp.enviar_mensaje') }}" method="POST" class="form-sena flex flex-col gap-4">
                    <div class="form-group">
                        <label for="rol_destinatario">Rol destinatario</label>
                        <select name="rol_destinatario" id="rol_destinatario" required>
                            <option value="">Seleccione rol</option>
                            <option value="Coordinador">Coordinador</option>
                            <option value="Administrador">Administrador</option>
                            <option value="Aprendiz">Aprendiz</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="destinatario_id">Destinatario específico (opcional)</label>
                        <select name="destinatario_id" id="destinatario_id">
                            <option value="">Todos</option>
                            {% for a in aprendices %}
                            <option class="aprendiz" value="{{ a.id_aprendiz }}">Aprendiz: {{ a.nombre }} {{ a.apellido }} - {{ a.ficha }}</option>
                            {% endfor %}
                            {% for c in coordinadores %}
                            <option class="coordinador" value="{{ c.id_coordinador }}">Coordinador: {{ c.nombre }} {{ c.apellido }}</option>
                            {% endfor %}
                            {% for adm in administradores %}
                            <option class="administrador" value="{{ adm.id_admin }}">Administrador: {{ adm.nombre }} {{ adm.apellido }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="mensaje">Mensaje</label>
                        <textarea name="mensaje" id="mensaje" rows="4" placeholder="Escribe tu mensaje aquí..." required></textarea>
                    </div>

                    <button type="submit" class="btn-sena-primary">Enviar</button>
                </form>
            </div>
        </div>
    </div>
</main>

<!-- Modal -->
<div id="modal" class="modal">
    <div class="modal-content">
        <h3>Notificación</h3>
        <div id="modal-body"></div>
        <button onclick="cerrarModal()">Aceptar</button>
    </div>
</div>

<!-- Footer -->
<footer class="mt-auto bg-sena-dark py-6">
    <div class="container mx-auto px-4">
        <div class="flex flex-col justify-between items-center">
            <div class="text-white text-center md:text-right">
                <p class="text-center">© {{ now.year|default(2023) }} SENA - Servicio Nacional de Aprendizaje</p>
                <p class="mt-1 text-center">Sistema de Seguimiento de Etapa Productiva</p>
            </div>
        </div>
    </div>
</footer>
<script>
// Calendario
const calendario = document.getElementById("calendario");
const mesSelect = document.getElementById("mes");
const btnMesAnterior = document.getElementById("mesAnterior");
const btnMesSiguiente = document.getElementById("mesSiguiente");
const anioSelect = document.getElementById("anio");
const btnAnioAnterior = document.getElementById("anioAnterior");
const btnAnioSiguiente = document.getElementById("anioSiguiente");
const modal = document.getElementById("modal");
const modalBody = document.getElementById("modal-body");

let fechaHoy = new Date();
let mesActual = fechaHoy.getMonth();
let añoActual = fechaHoy.getFullYear();

for (let i = añoActual - 50; i <= añoActual + 50; i++) {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = i;
    anioSelect.appendChild(option);
}
anioSelect.value = añoActual;

const eventos = {{ eventos|tojson }};

function generarCalendario(mes) {
    calendario.innerHTML = "";
    const primerDia = new Date(añoActual, mes, 1).getDay();
    const diasMes = new Date(añoActual, mes + 1, 0).getDate();
    let inicio = primerDia === 0 ? 6 : primerDia - 1;

    for (let i = 0; i < inicio; i++) {
        const div = document.createElement("div");
        div.className = "p-2 border border-gray-100";
        calendario.appendChild(div);
    }

    for (let d = 1; d <= diasMes; d++) {
        const div = document.createElement("div");
        div.textContent = d;
        div.className = "p-2 border border-gray-200 hover:bg-blue-100 cursor-pointer rounded-lg";

        if (mes === fechaHoy.getMonth() && d === fechaHoy.getDate() && añoActual === fechaHoy.getFullYear()) {
            div.classList.add("bg-sena-primary", "text-white", "font-bold", "shadow-md", "rounded-full", "w-8", "h-8", "flex", "items-center", "justify-center", "mx-auto");
        }

        const pos = inicio + d - 1;
        if (pos % 7 === 5 || pos % 7 === 6) div.classList.add("text-red-600", "font-semibold");

        // --- Normalizar fecha del día ---
        const fechaDiaObj = new Date(añoActual, mes, d);
        fechaDiaObj.setHours(0,0,0,0);

        // --- Buscar eventos que caigan en este día (solo el día exacto) ---
        const eventosDelDia = eventos.filter(e => {
            // Parseamos la fecha de forma segura como YYYY-MM-DD para evitar desplazamientos por zona horaria
            let fechaFin;
            if (typeof e.fecha_fin === 'string') {
                // si viene con hora (ej. "2025-09-29T00:00:00") cortamos la parte de la fecha
                const fechaStr = e.fecha_fin.split('T')[0];
                const parts = fechaStr.split('-');
                if (parts.length >= 3) {
                    fechaFin = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
                } else {
                    fechaFin = new Date(e.fecha_fin);
                }
            } else {
                fechaFin = new Date(e.fecha_fin);
            }

            fechaFin.setHours(0,0,0,0); // normalizar fecha fin a medianoche local
            return fechaDiaObj.getTime() === fechaFin.getTime(); // ✅ solo el día exacto
        });

        if (eventosDelDia.length > 0) {
            div.classList.add("bg-green-400", "text-white", "font-bold", "shadow-md");
            div.title = eventosDelDia.map(e =>
                `Nombre: ${e.nombre}\nFicha: ${e.ficha}\nInicio: ${e.fecha_inicio}\nFin: ${e.fecha_fin}`
            ).join("\n\n");

            div.addEventListener("click", () =>
                abrirModal("Detalles del Aprendiz", eventosDelDia.map(e =>
                    `<p><strong>Nombre:</strong> ${e.nombre}</p>
                     <p><strong>Ficha:</strong> ${e.ficha}</p>
                     <p><strong>Inicio:</strong> ${e.fecha_inicio}</p>
                     <p><strong>Fin:</strong> ${e.fecha_fin}</p>`
                ).join("<hr>"))
            );
        }

        calendario.appendChild(div);
    }
}

function abrirModal(titulo, contenido) {
    modal.querySelector("h3").textContent = titulo;
    modalBody.innerHTML = contenido;
    modal.style.display = "flex";
}
function cerrarModal() { modal.style.display = "none"; }

mesSelect.addEventListener("change", () => { mesActual = parseInt(mesSelect.value); generarCalendario(mesActual); });
anioSelect.addEventListener("change", () => { añoActual = parseInt(anioSelect.value); generarCalendario(mesActual); });
btnMesAnterior.addEventListener("click", () => { mesActual = (mesActual - 1 + 12) % 12; if (mesActual === 11) añoActual--; mesSelect.value = mesActual; anioSelect.value = añoActual; generarCalendario(mesActual); });
btnMesSiguiente.addEventListener("click", () => { mesActual = (mesActual + 1) % 12; if (mesActual === 0) añoActual++; mesSelect.value = mesActual; anioSelect.value = añoActual; generarCalendario(mesActual); });
btnAnioAnterior.addEventListener("click", () => { añoActual--; anioSelect.value = añoActual; generarCalendario(mesActual); });
btnAnioSiguiente.addEventListener("click", () => { añoActual++; anioSelect.value = añoActual; generarCalendario(mesActual); });

mesSelect.value = mesActual;
generarCalendario(mesActual);
window.addEventListener("click", (event) => { if (event.target === modal) cerrarModal(); });

// Flash messages en modal
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      abrirModal("{{ category|capitalize }}", "{{ message|safe }}");
    {% endfor %}
  {% endif %}
{% endwith %}

// Filtrar destinatarios por rol
const rolSelect = document.getElementById('rol_destinatario');
const destinatarioSelect = document.getElementById('destinatario_id');

rolSelect.addEventListener('change', () => {
    const rol = rolSelect.value;
    for (const option of destinatarioSelect.options) {
        if (option.value === "") { option.style.display = 'block'; continue; }
        if (option.classList.contains(rol.toLowerCase())) option.style.display = 'block';
        else option.style.display = 'none';
    }
    destinatarioSelect.value = "";
});
</script>


{% endblock %}
